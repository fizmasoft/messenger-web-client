import fs from 'fs';
import FormData from 'form-data';
import { ENV } from '../config';
import { request } from '../utility/request';
import { getDateDDMMYYYY } from '../utility/date-formatter';
var TelegramBotApiMethods;
(function (TelegramBotApiMethods) {
    TelegramBotApiMethods["GET_UPDATES"] = "getUpdates";
    TelegramBotApiMethods["SEND_MESSAGE"] = "sendMessage";
    TelegramBotApiMethods["SEND_MEDIA_GROUP"] = "sendMediaGroup";
    TelegramBotApiMethods["SEND_PHOTO"] = "sendPhoto";
    TelegramBotApiMethods["SEND_DOCUMENT"] = "sendDocument";
})(TelegramBotApiMethods || (TelegramBotApiMethods = {}));
export var TelegramParseModeEnum;
(function (TelegramParseModeEnum) {
    TelegramParseModeEnum["HTML"] = "HTML";
})(TelegramParseModeEnum || (TelegramParseModeEnum = {}));
class TelegramBot {
    #baseUrl;
    constructor(token) {
        this.#baseUrl = `https://api.telegram.org/bot${token}/`;
    }
    async send(method, body) {
        try {
            return await request({
                method: 'POST',
                url: `${this.#baseUrl}${method}`,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: body,
            });
        }
        catch (err) {
            console.log(err, 'error while telegram.send');
        }
    }
    async sendMessage(msg, chat_id = ENV.BOT.CHAT_ID) {
        try {
            await request({
                method: 'POST',
                url: `${this.#baseUrl}${TelegramBotApiMethods.SEND_MESSAGE}`,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: chat_id,
                    text: msg,
                    parse_mode: 'HTML',
                }),
            });
        }
        catch (err) {
            console.log(err, 'error while telegram.sendMessage');
        }
    }
    async sendError(err) {
        try {
            await request({
                method: 'POST',
                url: `${this.#baseUrl}${TelegramBotApiMethods.SEND_MESSAGE}`,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: ENV.BOT.CHAT_ID,
                    text: err instanceof Error ? err.message : err,
                }),
            });
        }
        catch (err) {
            console.log(err, 'error while telegram.sendError');
        }
    }
    async sendMedia({ media, msg, chat_id = ENV.BOT.CHAT_ID, parse_mode = TelegramParseModeEnum.HTML, }) {
        if (media.length < 1) {
            return { success: false, message: 'Photos at least one photo' };
        }
        try {
            if (media.length === 1) {
                await this.send(TelegramBotApiMethods.SEND_PHOTO, JSON.stringify({
                    chat_id: chat_id,
                    photo: media[0],
                    caption: msg,
                    parse_mode: 'HTML',
                }));
                return { success: true, message: 'OK' };
            }
            const body = new Array(media.length);
            for (let i = 0; i < media.length; i++) {
                body[i] = {
                    type: 'photo',
                    media: media[i],
                };
            }
            body[body.length - 1].caption = msg;
            body[body.length - 1].parse_mode = parse_mode;
            await this.send(TelegramBotApiMethods.SEND_MEDIA_GROUP, JSON.stringify({
                chat_id: chat_id,
                media: body,
            }));
            return { success: true, message: 'OK' };
        }
        catch (error) {
            return {
                success: false,
                message: JSON.stringify(error.response.data),
            };
        }
    }
    async sendDocument(path, opts = { chatId: ENV.BOT.CHAT_ID.toString(), caption: '#canceled_contract_list' }) {
        const formData = new FormData();
        formData.append('chat_id', opts.chatId);
        formData.append('document', fs.createReadStream(path), {
            filename: getDateDDMMYYYY(new Date()),
            contentType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        });
        formData.append('caption', opts.caption);
        await this.send(TelegramBotApiMethods.SEND_DOCUMENT, formData);
        return fs.unlink(path, (err) => {
            if (err)
                this.sendMessage(`Excel file o'chirishda xatolik bor !!!\n\nXatolik habari ${err.message}`);
            console.log("Fayl o'chirildi");
        });
    }
}
export const telegramBot = new TelegramBot(ENV.BOT.TOKEN);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVsZWdyYW0tYm90LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1vbi90ZWxlZ3JhbS90ZWxlZ3JhbS1ib3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3BCLE9BQU8sUUFBUSxNQUFNLFdBQVcsQ0FBQztBQUNqQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRWhDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFNUQsSUFBSyxxQkFNSjtBQU5ELFdBQUsscUJBQXFCO0lBQ3hCLG1EQUEwQixDQUFBO0lBQzFCLHFEQUE0QixDQUFBO0lBQzVCLDREQUFtQyxDQUFBO0lBQ25DLGlEQUF3QixDQUFBO0lBQ3hCLHVEQUE4QixDQUFBO0FBQ2hDLENBQUMsRUFOSSxxQkFBcUIsS0FBckIscUJBQXFCLFFBTXpCO0FBRUQsTUFBTSxDQUFOLElBQVkscUJBRVg7QUFGRCxXQUFZLHFCQUFxQjtJQUMvQixzQ0FBYSxDQUFBO0FBQ2YsQ0FBQyxFQUZXLHFCQUFxQixLQUFyQixxQkFBcUIsUUFFaEM7QUFFRCxNQUFNLFdBQVc7SUFDTixRQUFRLENBQVM7SUFFMUIsWUFBWSxLQUFhO1FBQ3ZCLElBQUksQ0FBQyxRQUFRLEdBQUcsK0JBQStCLEtBQUssR0FBRyxDQUFDO0lBQzFELENBQUM7SUFFTyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQTZCLEVBQUUsSUFBdUI7UUFDdkUsSUFBSSxDQUFDO1lBQ0gsT0FBTyxNQUFNLE9BQU8sQ0FBQztnQkFDbkIsTUFBTSxFQUFFLE1BQU07Z0JBQ2QsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLEVBQUU7Z0JBQ2hDLE9BQU8sRUFBRTtvQkFDUCxjQUFjLEVBQUUsa0JBQWtCO2lCQUNuQztn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VUFBVSxFQUFFLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNyRCxRQUFRLEVBQUUsZUFBZSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7WUFDckMsV0FBVyxFQUFFLHlFQUF5RTtTQUN2RixDQUFDLENBQUM7UUFDSCxRQUFRLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFekMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUUvRCxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDN0IsSUFBSSxHQUFHO2dCQUNMLElBQUksQ0FBQyxXQUFXLENBQUMsNERBQTRELEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQzlGLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQUVELE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxJQUFJLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0IEZvcm1EYXRhIGZyb20gJ2Zvcm0tZGF0YSc7XHJcbmltcG9ydCB7IEVOViB9IGZyb20gJy4uL2NvbmZpZyc7XHJcbmltcG9ydCB7IFRlbGVncmFtIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IHJlcXVlc3QgfSBmcm9tICcuLi91dGlsaXR5L3JlcXVlc3QnO1xyXG5pbXBvcnQgeyBnZXREYXRlRERNTVlZWVkgfSBmcm9tICcuLi91dGlsaXR5L2RhdGUtZm9ybWF0dGVyJztcclxuXHJcbmVudW0gVGVsZWdyYW1Cb3RBcGlNZXRob2RzIHtcclxuICBHRVRfVVBEQVRFUyA9ICdnZXRVcGRhdGVzJyxcclxuICBTRU5EX01FU1NBR0UgPSAnc2VuZE1lc3NhZ2UnLFxyXG4gIFNFTkRfTUVESUFfR1JPVVAgPSAnc2VuZE1lZGlhR3JvdXAnLFxyXG4gIFNFTkRfUEhPVE8gPSAnc2VuZFBob3RvJyxcclxuICBTRU5EX0RPQ1VNRU5UID0gJ3NlbmREb2N1bWVudCcsXHJcbn1cclxuXHJcbmV4cG9ydCBlbnVtIFRlbGVncmFtUGFyc2VNb2RlRW51bSB7XHJcbiAgSFRNTCA9ICdIVE1MJyxcclxufVxyXG5cclxuY2xhc3MgVGVsZWdyYW1Cb3Qge1xyXG4gIHJlYWRvbmx5ICNiYXNlVXJsOiBzdHJpbmc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHRva2VuOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuI2Jhc2VVcmwgPSBgaHR0cHM6Ly9hcGkudGVsZWdyYW0ub3JnL2JvdCR7dG9rZW59L2A7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHNlbmQobWV0aG9kOiBUZWxlZ3JhbUJvdEFwaU1ldGhvZHMsIGJvZHk6IHN0cmluZyB8IEZvcm1EYXRhKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gYXdhaXQgcmVxdWVzdCh7XHJcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgdXJsOiBgJHt0aGlzLiNiYXNlVXJsfSR7bWV0aG9kfWAsXHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGJvZHk6IGJvZHksXHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGVyciwgJ2Vycm9yIHdoaWxlIHRlbGVncmFtLnNlbmQnKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBzZW5kTWVzc2FnZShtc2c6IHN0cmluZywgY2hhdF9pZCA9IEVOVi5CT1QuQ0hBVF9JRCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgcmVxdWVzdCh7XHJcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgdXJsOiBgJHt0aGlzLiNiYXNlVXJsfSR7VGVsZWdyYW1Cb3RBcGlNZXRob2RzLlNFTkRfTUVTU0FHRX1gLFxyXG4gICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICBjaGF0X2lkOiBjaGF0X2lkLFxyXG4gICAgICAgICAgdGV4dDogbXNnLFxyXG4gICAgICAgICAgcGFyc2VfbW9kZTogJ0hUTUwnLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBjb25zb2xlLmxvZyhlcnIsICdlcnJvciB3aGlsZSB0ZWxlZ3JhbS5zZW5kTWVzc2FnZScpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHNlbmRFcnJvcihlcnI6IEVycm9yIHwgdW5rbm93bikge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgcmVxdWVzdCh7XHJcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgdXJsOiBgJHt0aGlzLiNiYXNlVXJsfSR7VGVsZWdyYW1Cb3RBcGlNZXRob2RzLlNFTkRfTUVTU0FHRX1gLFxyXG4gICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICBjaGF0X2lkOiBFTlYuQk9ULkNIQVRfSUQsXHJcbiAgICAgICAgICB0ZXh0OiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogZXJyLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBjb25zb2xlLmxvZyhlcnIsICdlcnJvciB3aGlsZSB0ZWxlZ3JhbS5zZW5kRXJyb3InKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBzZW5kTWVkaWEoe1xyXG4gICAgbWVkaWEsXHJcbiAgICBtc2csXHJcbiAgICBjaGF0X2lkID0gRU5WLkJPVC5DSEFUX0lELFxyXG4gICAgcGFyc2VfbW9kZSA9IFRlbGVncmFtUGFyc2VNb2RlRW51bS5IVE1MLFxyXG4gIH06IFRlbGVncmFtLlNlbmRNZWRpYUR0byk6IFByb21pc2U8VGVsZWdyYW0uUmVzcG9uc2U+IHtcclxuICAgIGlmIChtZWRpYS5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnUGhvdG9zIGF0IGxlYXN0IG9uZSBwaG90bycgfTtcclxuICAgIH1cclxuICAgIHRyeSB7XHJcbiAgICAgIGlmIChtZWRpYS5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLnNlbmQoXHJcbiAgICAgICAgICBUZWxlZ3JhbUJvdEFwaU1ldGhvZHMuU0VORF9QSE9UTyxcclxuICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgY2hhdF9pZDogY2hhdF9pZCxcclxuICAgICAgICAgICAgcGhvdG86IG1lZGlhWzBdLFxyXG4gICAgICAgICAgICBjYXB0aW9uOiBtc2csXHJcbiAgICAgICAgICAgIHBhcnNlX21vZGU6ICdIVE1MJyxcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIG1lc3NhZ2U6ICdPSycgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgYm9keSA9IG5ldyBBcnJheShtZWRpYS5sZW5ndGgpO1xyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1lZGlhLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgYm9keVtpXSA9IHtcclxuICAgICAgICAgIHR5cGU6ICdwaG90bycsXHJcbiAgICAgICAgICBtZWRpYTogbWVkaWFbaV0sXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgYm9keVtib2R5Lmxlbmd0aCAtIDFdLmNhcHRpb24gPSBtc2c7XHJcbiAgICAgIGJvZHlbYm9keS5sZW5ndGggLSAxXS5wYXJzZV9tb2RlID0gcGFyc2VfbW9kZTtcclxuXHJcbiAgICAgIGF3YWl0IHRoaXMuc2VuZChcclxuICAgICAgICBUZWxlZ3JhbUJvdEFwaU1ldGhvZHMuU0VORF9NRURJQV9HUk9VUCxcclxuICAgICAgICBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICBjaGF0X2lkOiBjaGF0X2lkLFxyXG4gICAgICAgICAgbWVkaWE6IGJvZHksXHJcbiAgICAgICAgfSksXHJcbiAgICAgICk7XHJcblxyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiAnT0snIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KGVycm9yLnJlc3BvbnNlLmRhdGEpLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHNlbmREb2N1bWVudChcclxuICAgIHBhdGg6IHN0cmluZyxcclxuICAgIG9wdHMgPSB7IGNoYXRJZDogRU5WLkJPVC5DSEFUX0lELnRvU3RyaW5nKCksIGNhcHRpb246ICcjY2FuY2VsZWRfY29udHJhY3RfbGlzdCcgfSxcclxuICApIHtcclxuICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XHJcblxyXG4gICAgZm9ybURhdGEuYXBwZW5kKCdjaGF0X2lkJywgb3B0cy5jaGF0SWQpO1xyXG4gICAgZm9ybURhdGEuYXBwZW5kKCdkb2N1bWVudCcsIGZzLmNyZWF0ZVJlYWRTdHJlYW0ocGF0aCksIHtcclxuICAgICAgZmlsZW5hbWU6IGdldERhdGVERE1NWVlZWShuZXcgRGF0ZSgpKSxcclxuICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQud29yZHByb2Nlc3NpbmdtbC5kb2N1bWVudCcsXHJcbiAgICB9KTtcclxuICAgIGZvcm1EYXRhLmFwcGVuZCgnY2FwdGlvbicsIG9wdHMuY2FwdGlvbik7XHJcblxyXG4gICAgYXdhaXQgdGhpcy5zZW5kKFRlbGVncmFtQm90QXBpTWV0aG9kcy5TRU5EX0RPQ1VNRU5ULCBmb3JtRGF0YSk7XHJcblxyXG4gICAgcmV0dXJuIGZzLnVubGluayhwYXRoLCAoZXJyKSA9PiB7XHJcbiAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgdGhpcy5zZW5kTWVzc2FnZShgRXhjZWwgZmlsZSBvJ2NoaXJpc2hkYSB4YXRvbGlrIGJvciAhISFcXG5cXG5YYXRvbGlrIGhhYmFyaSAke2Vyci5tZXNzYWdlfWApO1xyXG4gICAgICBjb25zb2xlLmxvZyhcIkZheWwgbydjaGlyaWxkaVwiKTtcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHRlbGVncmFtQm90ID0gbmV3IFRlbGVncmFtQm90KEVOVi5CT1QuVE9LRU4pO1xyXG4iXX0=